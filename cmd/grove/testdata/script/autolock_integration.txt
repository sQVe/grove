# grove auto-lock integration tests
# Tests auto-lock behavior during clone and add

# Setup: Create test repository
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
cd ..

## Success: Clone creates locked main worktree

mkdir workspace
exec grove clone file://$WORK/testrepo workspace
cd workspace/main
exec git config user.name "Test"
exec git config user.email "test@example.com"

exec grove list --json
# Verify main worktree is auto-locked with reason
stdout '"name": "main"'
stdout '"locked": true'
stdout '"lock_reason": "Auto-locked \(grove.autoLock\)"'

## Success: Add non-default branch is not auto-locked

exec grove add feature
cd ../feature
exec grove status --json
# Feature should not be locked (explicit false check)
stdout '"locked": false'

## Verify: Main stays locked after adding feature

cd ../main
exec grove list --json
# Main should still be locked
stdout '"name": "main"'
stdout '"locked": true'
# Feature should be unlocked
stdout '"name": "feature"'

## Verify: List shows correct lock status

exec grove list --verbose --plain
stdout 'main.*\[locked\]'
stdout 'feature'
# Feature line should NOT have [locked]
! stdout 'feature.*\[locked\]'

## Success: Auto-locked worktree can be unlocked

exec grove unlock main
stderr 'Unlocked worktree'

# Verify main is now unlocked
exec grove status --json
stdout '"locked": false'

-- README.md --
# Test

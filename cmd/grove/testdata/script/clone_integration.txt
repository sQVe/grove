# Setup git config once
exec git config --global user.name "Test"
exec git config --global user.email "test@example.com"
exec git config --global commit.gpgsign false

# Setup test repository fixture with all branches needed for tests
mkdir testrepo
exec git init testrepo
cd testrepo
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b develop
exec git checkout -b feat/user-auth
exec git checkout main
cd ..

## Success paths

# Test successful clone with branches
mkdir clone-with-branches
exec grove clone file://$WORK/testrepo clone-with-branches --branches main,develop
stdout 'Cloned repository to.*clone-with-branches'
! stderr .
exists clone-with-branches/.bare
exists clone-with-branches/.git
exists clone-with-branches/main
exists clone-with-branches/develop
exists clone-with-branches/main/README.md
exists clone-with-branches/develop/README.md

## Output format tests

# Test clone output shows worktree creation by default (quiet mode)
mkdir clone-quiet-output
exec grove clone file://$WORK/testrepo clone-quiet-output --branches main,develop
stdout 'Repository cloned'
stdout 'Creating worktrees'
# Worktrees created in order specified in --branches flag
stdout '✓ main'
stdout '✓ develop'
stdout 'Cloned repository to.*clone-quiet-output'
! stderr .
# Quiet mode suppresses git progress output
! stdout 'Enumerating objects'
! stdout 'Counting objects'
! stdout 'Compressing objects'
! stdout 'Receiving objects'

# Test clone with branch name sanitization output
mkdir clone-sanitize-branches
exec grove clone file://$WORK/testrepo clone-sanitize-branches --branches feat/user-auth
stdout 'Creating worktrees'
stdout '✓ feat-user-auth'
stdout 'Cloned repository to.*clone-sanitize-branches'
! stderr .
exists clone-sanitize-branches/feat-user-auth

# Test clone with --verbose flag shows git output
mkdir clone-verbose-output
exec grove clone file://$WORK/testrepo clone-verbose-output --branches main --verbose
stdout 'Creating worktrees'
stdout '✓ main'
stdout 'Cloned repository to.*clone-verbose-output'
# Verbose mode shows git clone/worktree progress on stderr
stderr 'Cloning into bare repository'
stderr 'Preparing worktree'

# Test clone error output remains visible in quiet mode
mkdir clone-error-output
! exec grove clone file:///nonexistent/repo.git clone-error-output
stderr 'failed to clone repository'

## Branch validation with real repository

# Test clone with invalid branch fails with specific error
mkdir clone-invalid-branch
! exec grove clone file://$WORK/testrepo clone-invalid-branch --branches "nonexistent"
stderr 'failed to create worktree for branch.*nonexistent.*invalid reference'

## Partial failure cleanup

# Test clone with mix of valid/invalid branches cleans up on failure
mkdir clone-partial-failure
! exec grove clone file://$WORK/testrepo clone-partial-failure --branches main,nonexistent
stderr 'failed to create worktree for branch.*nonexistent'
# Workspace should be cleaned up (no .bare directory)
! exists clone-partial-failure/.bare
! exists clone-partial-failure/main

-- README.md --
# Test Repository
This is a test repository for grove.
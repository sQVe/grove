# grove clone integration tests
# Tests repository cloning with worktree setup

# Setup: Create test repository with branches
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b develop
exec git checkout -b feat/user-auth
exec git checkout main
cd ..

## Success: Clone with branches

# Clone creates worktrees for specified branches
mkdir clone-with-branches
exec grove clone file://$WORK/testrepo clone-with-branches --branches main,develop
stdout 'Cloned repository to.*clone-with-branches'
! stderr .
exists clone-with-branches/.bare
exists clone-with-branches/.git
exists clone-with-branches/main
exists clone-with-branches/develop
exists clone-with-branches/main/README.md
exists clone-with-branches/develop/README.md

## Output: Default mode shows progress

# Default mode shows worktree creation
mkdir clone-quiet-output
exec grove clone file://$WORK/testrepo clone-quiet-output --branches main,develop
stdout 'Repository cloned'
stdout 'Creating worktrees'
# Worktrees created in order specified in --branches flag
stdout '✓ main'
stdout '✓ develop'
stdout 'Cloned repository to.*clone-quiet-output'
! stderr .
# Quiet mode suppresses git progress output
! stdout 'Enumerating objects'
! stdout 'Counting objects'
! stdout 'Compressing objects'
! stdout 'Receiving objects'

# Branch name sanitization in output
mkdir clone-sanitize-branches
exec grove clone file://$WORK/testrepo clone-sanitize-branches --branches feat/user-auth
stdout 'Creating worktrees'
stdout '✓ feat-user-auth'
stdout 'Cloned repository to.*clone-sanitize-branches'
! stderr .
exists clone-sanitize-branches/feat-user-auth

## Output: Verbose mode shows git output
mkdir clone-verbose-output
exec grove clone file://$WORK/testrepo clone-verbose-output --branches main --verbose
stdout 'Creating worktrees'
stdout '✓ main'
stdout 'Cloned repository to.*clone-verbose-output'
# Verbose mode shows git clone/worktree progress on stderr
stderr 'Cloning into bare repository'
stderr 'Preparing worktree'

## Error: Output remains visible
mkdir clone-error-output
! exec grove clone file:///nonexistent/repo.git clone-error-output
stderr 'failed to clone repository'

## Error: Invalid branch
mkdir clone-invalid-branch
! exec grove clone file://$WORK/testrepo clone-invalid-branch --branches "nonexistent"
stderr 'failed to create worktree for branch.*nonexistent.*invalid reference'

## Error: Partial failure cleans up
mkdir clone-partial-failure
! exec grove clone file://$WORK/testrepo clone-partial-failure --branches main,nonexistent
stderr 'failed to create worktree for branch.*nonexistent'
# Workspace should be cleaned up (no .bare directory)
! exists clone-partial-failure/.bare
! exists clone-partial-failure/main

## Success: Relative path

# Relative path creates absolute path
mkdir clone-rel-path-parent
exec grove clone file://$WORK/testrepo clone-rel-path-parent/myrepo --branches main
exists clone-rel-path-parent/myrepo/.bare
exists clone-rel-path-parent/myrepo/main

## Success: Absolute path
exec grove clone file://$WORK/testrepo $WORK/clone-abs-path --branches main
exists $WORK/clone-abs-path/.bare
exists $WORK/clone-abs-path/main

## Success: Path with spaces
mkdir 'clone with spaces'
exec grove clone file://$WORK/testrepo 'clone with spaces/my repo' --branches main
exists 'clone with spaces/my repo/.bare'
exists 'clone with spaces/my repo/main'

## Success: Creates non-existent parent directories
exec grove clone file://$WORK/testrepo nonexistent/parent/dirs/repo --branches main
exists nonexistent/parent/dirs/repo/.bare
exists nonexistent/parent/dirs/repo/main

## Edge case: --branches with whitespace trimmed
mkdir clone-whitespace-branches
exec grove clone file://$WORK/testrepo clone-whitespace-branches --branches ' main , develop '
exists clone-whitespace-branches/main
exists clone-whitespace-branches/develop
! stderr .

## Edge case: --branches with empty segments filtered
mkdir clone-empty-segments
exec grove clone file://$WORK/testrepo clone-empty-segments --branches 'main,,develop'
exists clone-empty-segments/main
exists clone-empty-segments/develop
! stderr .

## Edge case: --branches with leading/trailing commas
mkdir clone-commas
exec grove clone file://$WORK/testrepo clone-commas --branches ',main,develop,'
exists clone-commas/main
exists clone-commas/develop
! stderr .

## Success: Multiple slashes sanitized to dashes
mkdir clone-multi-slash
cd testrepo
exec git checkout -b release/v1/patch
exec git checkout main
cd ..
exec grove clone file://$WORK/testrepo clone-multi-slash --branches release/v1/patch
exists clone-multi-slash/release-v1-patch
stdout 'release-v1-patch'
! stderr .

## Error: Duplicate branches
mkdir clone-duplicate-branches
! exec grove clone file://$WORK/testrepo clone-duplicate-branches --branches 'main,main'
stderr 'already exists'

## Edge case: Same repo cloned to different dirs
mkdir clone-twice-a
mkdir clone-twice-b
exec grove clone file://$WORK/testrepo clone-twice-a --branches main
exec grove clone file://$WORK/testrepo clone-twice-b --branches main
exists clone-twice-a/.bare
exists clone-twice-b/.bare

## Error: Same repo to same dir fails
mkdir clone-same-dir
exec grove clone file://$WORK/testrepo clone-same-dir --branches main
! exec grove clone file://$WORK/testrepo clone-same-dir --branches main
stderr 'cannot initialize grove inside existing grove workspace'

## Error: Cleanup on failure
mkdir clone-fail-cleanup
! exec grove clone file://$WORK/testrepo clone-fail-cleanup --branches nonexistent
! exists clone-fail-cleanup/.bare
! exists clone-fail-cleanup/.git

## Auto-lock: Branches matching pattern are locked
mkdir clone-auto-lock
exec grove clone file://$WORK/testrepo clone-auto-lock --branches main,develop
cd clone-auto-lock/.bare
# main and develop should be auto-locked (default patterns)
exec git worktree list --porcelain
stdout 'locked'
cd ../..

-- README.md --
# Test Repository
This is a test repository for grove.
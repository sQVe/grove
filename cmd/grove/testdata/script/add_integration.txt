# Create grove workspace via clone
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b existing-branch
exec git checkout main
cd ..

mkdir workspace
exec grove clone file://$WORK/testrepo workspace
cd workspace/main
exec git config user.name "Test"
exec git config user.email "test@example.com"

## Add worktree for existing branch

exec grove add existing-branch
stdout 'Created worktree'
exists ../existing-branch

## Add worktree for new branch

exec grove add feature/new-thing
stdout 'Created worktree'
exists ../feature-new-thing

## Error: branch already has worktree

! exec grove add existing-branch
stderr 'worktree already exists'

## Error: directory already exists (main already has worktree directory)

mkdir ../test-dir
! exec grove add test-dir
stderr 'directory already exists'

## Add with --switch outputs path only

cd $WORK/workspace/main
exec grove add --switch feature/switch-test
stdout '^.*/feature-switch-test$'
! stdout 'Created worktree'
exists ../feature-switch-test

## Add with -s shorthand outputs path only

exec grove add -s feature/short-flag
stdout '^.*/feature-short-flag$'
! stdout 'Created worktree'
exists ../feature-short-flag

## Error: not in workspace

cd /tmp
! exec grove add feature
stderr 'not in a grove workspace'

## Error: --base cannot be used with PR references

cd $WORK/workspace/main
! exec grove add --base main '#123'
stderr 'cannot be used with PR references'

## Error: --detach cannot be used with PR references

! exec grove add --detach '#123'
stderr 'cannot be used with PR references'

## Error: --detach and --base cannot be used together

! exec grove add --detach --base main v1.0.0
stderr 'cannot be used together'

-- README.md --
# Test

# grove init convert - lock file cleanup
# Tests that lock file is cleaned up on both success and failure

# Test lock file cleanup on successful conversion
mkdir convert-lock-success-test
cd convert-lock-success-test
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
# Convert and verify lock file is cleaned up
exec grove init convert
! exists .grove-convert.lock
exists .bare
exists .git
exists main/test-file.txt
cd ..

# Test lock file cleanup on conversion failure
mkdir convert-lock-failure-test
cd convert-lock-failure-test
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
# Create blocking directory to force conversion failure
mkdir main
cp $WORK/blocker main/blocker.txt
exec git add .
exec git commit -m 'add blocker'
! exec grove init convert
stderr 'âœ— failed to create worktree'
# Verify lock file was cleaned up even on failure
! exists .grove-convert.lock
exists .git
exists test-file.txt
cd ..

-- test-file.txt --
This is a test file

-- blocker --
blocking file

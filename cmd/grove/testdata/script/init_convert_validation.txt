## Help and basic functionality

# Test init convert command help
exec grove init convert --help
stdout 'Convert existing Git repository to a grove workspace'
stdout 'Usage:'
stdout '--branches'

## Argument validation

# Test init convert with no positional arguments
! exec grove init convert arg1
stderr 'unknown command'

## Pre-condition validation (in check order)

# Test init convert fails when not a git repository
mkdir not-git-repo
cd not-git-repo
! exec grove init convert
stderr 'not a git repository'
cd ..

# Test init convert fails when already grove workspace
mkdir already-grove
exec grove init new already-grove
cd already-grove
! exec grove init convert
stderr 'already a grove workspace'
cd ..

# Test init convert fails when repository is a worktree
mkdir convert-worktree-main
cd convert-worktree-main
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
exec git worktree add ../convert-worktree-feature feature
cd ../convert-worktree-feature
! exec grove init convert
stderr 'cannot convert: repository is already a worktree'
cd ..

# Test init convert with detached HEAD fails
mkdir convert-detached
cd convert-detached
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git checkout HEAD~0
! exec grove init convert
stderr 'cannot convert: repository is in detached HEAD state'
cd ..

# Test init convert with staged changes fails
mkdir convert-staged-changes
cd convert-staged-changes
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec sh -c 'echo "staged content" > staged-file.txt'
exec git add staged-file.txt
! exec grove init convert
stderr 'cannot convert: repository has uncommitted changes'
cd ..

# Test init convert fails with untracked files
mkdir convert-untracked-files
cd convert-untracked-files
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec sh -c 'echo "this file should not be deleted" > untracked.txt'
! exec grove init convert
stderr 'cannot convert: repository has uncommitted changes'
cd ..

# Test init convert fails with modified unstaged files
mkdir convert-modified-unstaged
cd convert-modified-unstaged
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec sh -c 'echo "modified content" >> test-file.txt'
! exec grove init convert
stderr 'cannot convert: repository has uncommitted changes'
cd ..

# Test init convert fails when repository has existing worktrees
mkdir convert-has-worktrees
cd convert-has-worktrees
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
exec git worktree add ../feature-worktree feature
! exec grove init convert
stderr 'cannot convert: repository has existing worktrees'
cd ..

# Test init convert fails when lock files are present
mkdir convert-lock-files
cd convert-lock-files
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec sh -c 'touch .git/index.lock'
! exec grove init convert
stderr 'cannot convert: repository has active lock files'
cd ..

# Test init convert fails when repository has submodules
mkdir convert-submodules
cd convert-submodules
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
cp ../gitmodules .gitmodules
! exec grove init convert
stderr 'cannot convert: repository has submodules'
cd ..

# Test init convert fails when repository has unresolved conflicts
mkdir convert-conflicts
cd convert-conflicts
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec sh -c 'touch .git/MERGE_HEAD'
! exec grove init convert
stderr 'cannot convert: repository has ongoing merge/rebase/cherry-pick'
cd ..

# Test init convert fails when repository has ongoing operations
mkdir convert-ongoing
cd convert-ongoing
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec sh -c 'touch .git/MERGE_HEAD'
! exec grove init convert
stderr 'cannot convert: repository has ongoing merge/rebase/cherry-pick'
cd ..

# Test init convert fails when repository has unpushed commits
mkdir convert-unpushed-remote
cd convert-unpushed-remote
exec git init --bare
cd ..
mkdir convert-unpushed
cd convert-unpushed
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git remote add origin ../convert-unpushed-remote
exec git push -u origin main
cp ../test-file2.txt .
exec git add .
exec git commit -m 'unpushed commit'
! exec grove init convert
stderr 'cannot convert: repository has unpushed commits'
cd ..

-- test-file.txt --
This is a test file

-- untracked.txt --
This file is untracked

-- test-file2.txt --
This is another test file

-- gitmodules --
[submodule "sub"]
	path = sub
	url = ../sub

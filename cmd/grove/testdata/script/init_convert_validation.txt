# grove init convert validation tests
# Tests init convert pre-condition checks

## Help output

# --help shows usage
exec grove init convert --help
stdout 'Convert existing Git repository to a grove workspace'
stdout 'Usage:'
stdout '--branches'
! stderr .

## Argument validation

# Rejects positional arguments
! exec grove init convert arg1
stderr '✗ unknown command "arg1" for "grove init convert"'

## Pre-condition validation

# Not a git repository
mkdir not-git-repo
cd not-git-repo
! exec grove init convert
stderr '✗ not a git repository'
cd ..

# Already grove workspace
mkdir already-grove
exec grove init new already-grove
cd already-grove
! exec grove init convert
stderr '✗ already a grove workspace'
cd ..

# Repository is a worktree
mkdir convert-worktree-main
cd convert-worktree-main
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
exec git worktree add ../convert-worktree-feature feature
cd ../convert-worktree-feature
! exec grove init convert
stderr '✗ cannot convert: repository is already a worktree'
cd ..

# Unborn HEAD (no commits)
mkdir convert-unborn
cd convert-unborn
exec git init
! exec grove init convert
stderr '✗ cannot convert: repository has no commits'
cd ..

# Detached HEAD
mkdir convert-detached
cd convert-detached
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git checkout HEAD~0
! exec grove init convert
stderr '✗ cannot convert: repository is in detached HEAD state'
cd ..

# Staged changes
mkdir convert-staged-changes
cd convert-staged-changes
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
cp $WORK/staged-file.txt staged-file.txt
exec git add staged-file.txt
! exec grove init convert
stderr '✗ cannot convert: repository has uncommitted changes'
cd ..

# Untracked files
mkdir convert-untracked-files
cd convert-untracked-files
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
cp $WORK/untracked.txt untracked.txt
! exec grove init convert
stderr '✗ cannot convert: repository has uncommitted changes'
cd ..

# Modified unstaged files
mkdir convert-modified-unstaged
cd convert-modified-unstaged
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
cp $WORK/modified-content.txt test-file.txt
! exec grove init convert
stderr '✗ cannot convert: repository has uncommitted changes'
cd ..

# Existing worktrees
mkdir convert-has-worktrees
cd convert-has-worktrees
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
exec git worktree add ../feature-worktree feature
! exec grove init convert
stderr '✗ cannot convert: repository has existing worktrees'
cd ..

# Lock files present
mkdir convert-lock-files
cd convert-lock-files
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec touch .git/index.lock
! exec grove init convert
stderr '✗ cannot convert: repository has active lock files'
cd ..

# Has submodules
mkdir convert-submodules
cd convert-submodules
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
cp ../gitmodules .gitmodules
! exec grove init convert
stderr '✗ cannot convert: repository has submodules'
cd ..

# Unresolved conflicts
mkdir convert-conflicts
cd convert-conflicts
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec touch .git/MERGE_HEAD
! exec grove init convert
stderr '✗ cannot convert: repository has ongoing merge/rebase/cherry-pick'
cd ..

# Ongoing merge/rebase/cherry-pick
mkdir convert-ongoing
cd convert-ongoing
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec touch .git/MERGE_HEAD
! exec grove init convert
stderr '✗ cannot convert: repository has ongoing merge/rebase/cherry-pick'
cd ..

# Unpushed commits
mkdir convert-unpushed-remote
cd convert-unpushed-remote
exec git init --bare
cd ..
mkdir convert-unpushed
cd convert-unpushed
exec git init
cp ../test-file.txt .
exec git add .
exec git commit -m 'initial commit'
exec git remote add origin ../convert-unpushed-remote
exec git push -u origin main
cp ../test-file2.txt .
exec git add .
exec git commit -m 'unpushed commit'
! exec grove init convert
stderr '✗ cannot convert: repository has unpushed commits'
cd ..

-- test-file.txt --
This is a test file

-- untracked.txt --
This file is untracked

-- test-file2.txt --
This is another test file

-- gitmodules --
[submodule "sub"]
	path = sub
	url = ../sub

-- staged-file.txt --
staged content

-- modified-content.txt --
This is a test file
modified content

# Create grove workspace via clone
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
cd ..

mkdir workspace
exec grove clone file://$WORK/testrepo workspace
cd workspace/main
exec git config user.name "Test"
exec git config user.email "test@example.com"

# Add a worktree to lock
exec grove add feature
! stderr .
exists ../feature

## Lock worktree without reason

exec grove lock feature
stdout 'Locked worktree'
! stderr .

## Error: already locked

! exec grove lock feature
stderr '^✗ worktree is already locked'

## List shows locked status

exec grove list --verbose --plain
stdout '\[locked\]'
! stderr .

## Status shows locked

cd ../feature
exec grove status --verbose --plain
stdout '\[locked\]'
! stderr .
cd ../main

## Lock with reason

exec grove unlock feature
! stderr .
exec grove lock feature --reason 'Do not delete'
stdout 'Locked worktree'
! stderr .

## List shows lock reason

exec grove list --verbose --plain
stdout 'Do not delete'
! stderr .

## Status shows lock reason

cd ../feature
exec grove status --verbose --plain
stdout 'Do not delete'
! stderr .
cd ../main

## Lock reason in JSON output

exec grove list --json
# Verify feature worktree has lock status and reason
stdout '"name": "feature"'
stdout '"locked": true'
stdout '"lock_reason": "Do not delete"'
! stderr .

## Error: worktree not found

! exec grove lock nonexistent
stderr '^✗ worktree not found: nonexistent'

## Error: not in workspace

cd /tmp
! exec grove lock feature
stderr '^✗ not in a grove workspace'

-- README.md --
# Test

# grove lock integration tests
# Tests worktree locking with real git state

# Setup: Create workspace via clone
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature
exec git checkout main
cd ..

mkdir workspace
exec grove clone file://$WORK/testrepo workspace
cd workspace/main
exec git config user.name "Test"
exec git config user.email "test@example.com"

# Add a worktree to lock
exec grove add feature
exists ../feature

## Success: Lock worktree without reason

exec grove lock feature
stderr 'Locked worktree'

## Error: Already locked

! exec grove lock feature
stderr 'already locked'

## Verify: List shows locked status

exec grove list --verbose --plain
stdout '\[locked\]'

## Verify: Status shows locked

cd ../feature
exec grove status --verbose --plain
stdout '\[locked\]'
cd ../main

## Success: Lock with reason

exec grove unlock feature
exec grove lock feature --reason 'Do not delete'
stderr 'Locked worktree'

## Verify: List shows lock reason

exec grove list --verbose --plain
stdout 'Do not delete'

## Verify: Status shows lock reason

cd ../feature
exec grove status --verbose --plain
stdout 'Do not delete'
cd ../main

## Verify: JSON output shows lock reason

exec grove list --json
# Verify feature worktree has lock status and reason
stdout '"name": "feature"'
stdout '"locked": true'
stdout '"lock_reason": "Do not delete"'

## Error: Worktree not found

! exec grove lock nonexistent
stderr '^✗ worktree not found: nonexistent'

## Error: Not in workspace

mkdir $WORK/outside
cd $WORK/outside
! exec grove lock feature
stderr '^✗ not in a grove workspace'
cd $WORK/workspace/main

## Success: Unlock output

exec grove unlock feature
stderr 'Unlocked worktree'

## Error: Unlock when not locked

! exec grove unlock feature
stderr 'worktree is not locked'

## Error: Unlock nonexistent worktree

! exec grove unlock nonexistent
stderr '^✗ worktree not found: nonexistent'

## Success: Branch name with slashes

exec grove add topic/slash-test
exec grove lock topic/slash-test
stderr 'Locked worktree'
exists ../topic-slash-test
exec grove unlock topic/slash-test
stderr 'Unlocked worktree'
exec grove remove topic-slash-test

## Success: From workspace root

cd $WORK/workspace
exec grove add from-root-test
exec grove lock from-root-test
stderr 'Locked worktree'
exec grove unlock from-root-test
stderr 'Unlocked worktree'
exec grove remove from-root-test
cd main

## Success: From worktree subdirectory

exec grove add subdir-test
mkdir ../subdir-test/deep/nested
cd ../subdir-test/deep/nested
exec grove lock subdir-test
stderr 'Locked worktree'
exec grove unlock subdir-test
stderr 'Unlocked worktree'
cd $WORK/workspace/main
exec grove remove subdir-test

## Integration: Remove blocked by lock

exec grove add remove-lock-test
exec grove lock remove-lock-test
! exec grove remove remove-lock-test
stderr 'worktree is locked'
exec grove unlock remove-lock-test
exec grove remove remove-lock-test
! exists ../remove-lock-test

## Integration: Remove --force auto-unlocks

exec grove add remove-force-test
exec grove lock remove-force-test
exec grove remove --force remove-force-test
stderr 'Deleted worktree'
! exists ../remove-force-test

## Integration: Move blocked by lock

exec grove add move-lock-test
exec grove lock move-lock-test
! exec grove move move-lock-test move-renamed
stderr 'worktree is locked'
exec grove unlock move-lock-test
exec grove remove move-lock-test

## Edge case: Empty reason

exec grove add empty-reason-test
exec grove lock empty-reason-test --reason ''
stderr 'Locked worktree'
exec grove unlock empty-reason-test
exec grove remove empty-reason-test

-- README.md --
# Test

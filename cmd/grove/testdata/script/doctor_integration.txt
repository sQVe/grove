# grove doctor integration tests
# Tests workspace issue detection with real git state

# Setup: Create workspace via clone
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
cd ..

mkdir workspace
exec grove clone file://$WORK/testrepo workspace
cd workspace/main
exec git config user.name "Test"
exec git config user.email "test@example.com"

## Clean workspace reports no issues

exec grove doctor
stderr '✓ No issues found'

## Detect broken .git pointer (missing file)

exec rm .git
! exec grove doctor
stdout 'Git Issues'
stdout '✗ Broken .git pointer'
stdout 'main'

## Detect stale worktree entry

# Restore .git first
cp $WORK/git-pointer .git

# Create orphaned worktree entry
mkdir ../.bare/worktrees/orphan-branch
cp $WORK/orphan-gitdir ../.bare/worktrees/orphan-branch/gitdir

! exec grove doctor
stdout 'Git Issues'
stdout '✗ Stale worktree entry'
stdout 'orphan-branch'

# Clean up orphan entry for remaining tests
exec rm -rf ../.bare/worktrees/orphan-branch

## Detect stale worktree entry with relative path

mkdir ../.bare/worktrees/orphan-relative
cp $WORK/orphan-relative-gitdir ../.bare/worktrees/orphan-relative/gitdir

! exec grove doctor
stdout 'Git Issues'
stdout '✗ Stale worktree entry'
stdout 'orphan-relative'

exec rm -rf ../.bare/worktrees/orphan-relative

## Detect invalid TOML syntax

cp $WORK/invalid.toml ../.grove.toml
! exec grove doctor
stdout 'Configuration'
stdout '✗ Invalid .grove.toml'

# Clean up for next test
exec rm ../.grove.toml

## Detect non-executable hook command

cp $WORK/hooks-nonexistent.toml ../.grove.toml
exec grove doctor
stdout 'Configuration'
stdout '⚠ Hook command not found'
stdout 'nonexistent-command-xyz'

# Clean up for next test
exec rm ../.grove.toml

## Detect stale lock file

exec touch ../.grove-convert.lock
exec grove doctor
stdout 'Configuration'
stdout '⚠ Stale lock file'

## Fix stale lock file with --fix

exec grove doctor --fix
stderr 'Fixed: Stale lock file'
! exists ../.grove-convert.lock

## Fix stale worktree entry with --fix

mkdir ../.bare/worktrees/orphan-fix-test
cp $WORK/orphan-gitdir ../.bare/worktrees/orphan-fix-test/gitdir
exec grove doctor --fix
stderr 'Fixed: Stale worktree entry'
! exists ../.bare/worktrees/orphan-fix-test

## Fix broken .git pointer with --fix

exec rm .git
exec grove doctor --fix
stderr 'Fixed: Broken .git pointer'
exists .git
exec grove doctor
stderr '✓ No issues found'

## JSON output format

cp $WORK/invalid.toml ../.grove.toml
! exec grove doctor --json
stdout '"category": "config"'
stdout '"severity": "error"'
stdout '"message": "Invalid .grove.toml"'
stdout '"errors": 1'

# Clean up for next test
exec rm ../.grove.toml

## Performance analysis with --perf

exec grove doctor --perf
stdout 'Disk Usage'
stdout 'main'

-- README.md --
# Test fixture

-- git-pointer --
gitdir: ../.bare/worktrees/main

-- orphan-gitdir --
/nonexistent/path

-- orphan-relative-gitdir --
../../nonexistent-worktree/.git

-- invalid.toml --
this is not valid toml [[[

-- hooks-nonexistent.toml --
[hooks]
add = ["nonexistent-command-xyz"]

# grove move integration tests
# Tests worktree lookup and protection

# Setup workspace with multiple worktrees
mkdir testrepo
exec git init testrepo
cd testrepo
exec git config user.name "Test"
exec git config user.email "test@example.com"
exec git config commit.gpgsign false
cp ../README.md .
exec git add .
exec git commit -m 'initial commit'
exec git checkout -b feature-branch
exec git checkout -b develop
exec git checkout main
cd ..

mkdir workspace
exec grove clone file://$WORK/testrepo workspace
cd workspace/main
exec git config user.name "Test"
exec git config user.email "test@example.com"

# Create worktrees for testing
exec grove add feature-branch
exec grove add develop

## Worktree Lookup

# Match by directory name (exact) → finds worktree
exec grove add to-move-dir
exists ../to-move-dir
exec grove move to-move-dir renamed-branch
stderr 'Renamed to-move-dir to renamed-branch'
! exists ../to-move-dir
exists ../renamed-branch

# Match by branch name (fallback) → finds worktree
exec grove add feature/slash-lookup
exists ../feature-slash-lookup
exec grove move feature/slash-lookup feature/renamed
stderr 'Renamed feature/slash-lookup to feature/renamed'
! exists ../feature-slash-lookup
exists ../feature-renamed

# Directory name takes precedence over branch name
exec grove add --name dir-precedence some-branch-name
exists ../dir-precedence
exec grove move dir-precedence new-dir-precedence
stderr 'Renamed dir-precedence to new-dir-precedence'
! exists ../dir-precedence
exists ../new-dir-precedence

# Worktree not found → error
! exec grove move nonexistent-worktree new-name
stderr '✗ worktree not found'

## Current Worktree Protection

# CWD is target worktree → error
exec grove add cwd-test
cd ../cwd-test
! exec grove move cwd-test cwd-renamed
stderr '✗ cannot rename current worktree'
cd ../main

# CWD is subdirectory of target → error
exec grove add subdir-cwd-test
mkdir ../subdir-cwd-test/deep/nested
cd ../subdir-cwd-test/deep/nested
! exec grove move subdir-cwd-test subdir-renamed
stderr '✗ cannot rename current worktree'
cd $WORK/workspace/main

# CWD is different worktree → allowed
exec grove move subdir-cwd-test moved-from-main
stderr 'Renamed subdir-cwd-test to moved-from-main'
exists ../moved-from-main

# CWD is workspace root → allowed
cd $WORK/workspace
exec grove move cwd-test moved-from-root
stderr 'Renamed cwd-test to moved-from-root'
exists moved-from-root
cd main

## Branch Name Validation

# New branch already exists locally → error
exec grove add existing-local
! exec grove move existing-local develop
stderr '✗ branch.*already exists'
exec grove remove existing-local

# New branch exists on remote → error (via refs)
# Create a branch in the origin repo
cd $WORK/testrepo
exec git checkout -b remote-only-branch
exec git checkout main
cd $WORK/workspace/main
# Fetch with refspec to create remote tracking branch
exec git fetch origin remote-only-branch:refs/remotes/origin/remote-only-branch
exec grove add local-to-remote
! exec grove move local-to-remote remote-only-branch
stderr '✗ branch.*already exists'
exec grove remove local-to-remote

-- README.md --
# Test Repository

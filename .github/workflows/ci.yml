name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

env:
  GO_VERSION: '1.24.5'

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**.go'
              - 'go.mod'
              - 'go.sum'
              - '.golangci.yml'
              - '.github/workflows/ci.yml'

  lint:
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.7.2

  test-unit:
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: |
          git config --global user.email "ci@grove.dev"
          git config --global user.name "Grove CI"
          git config --global init.defaultBranch main
          git config --global commit.gpgsign false
      - run: go install gotest.tools/gotestsum@v1.12.0
      - run: go install github.com/magefile/mage@v1.15.0
      - run: mage test:coverage
        env:
          CI: 'true'

  test-integration:
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go install gotest.tools/gotestsum@v1.12.0
      - run: go install github.com/magefile/mage@v1.15.0
      - run: |
          git config --global user.email "ci@grove.dev"
          git config --global user.name "Grove CI"
          git config --global init.defaultBranch main
          git config --global commit.gpgsign false
      - run: mage test:integration
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  require-changeset:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changeset requirement
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_LABELS: ${{ toJson(github.event.pull_request.labels.*.name) }}
        run: |
          # Skip for dependency updates (Dependabot/Renovate)
          if echo "$PR_LABELS" | grep -q '"dependencies"'; then
            echo "Skipping changeset check for dependency update"
            exit 0
          fi

          # Get changed files
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")

          # Check if any code files changed (excluding tests)
          CODE_CHANGED="false"
          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # Skip non-code files
            case "$file" in
              *.md|docs/*|.github/*|.changes/*) continue ;;
              *_test.go) continue ;;
            esac

            # Check for actual code changes
            case "$file" in
              cmd/*.go|internal/*.go|go.mod|go.sum|magefile.go)
                CODE_CHANGED="true"
                echo "Code change: $file"
                ;;
            esac
          done <<< "$CHANGED"

          if [ "$CODE_CHANGED" = "false" ]; then
            echo "No code changes requiring a changeset"
            exit 0
          fi

          # Check for changeset file
          CHANGESET=$(git diff --name-only --diff-filter=A "$BASE_SHA" "$HEAD_SHA" | grep '^\.changes/unreleased/.*\.yaml$' || true)

          if [ -z "$CHANGESET" ]; then
            echo "::error::This PR changes code but is missing a changeset."
            echo ""
            echo "Add a changeset by running:"
            echo "  changie new"
            echo ""
            echo "Or with mage:"
            echo "  mage change"
            exit 1
          fi

          echo "Found changeset: $CHANGESET"

  build:
    needs: [changes, lint, test-unit]
    if: needs.changes.outputs.code == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - run: go install github.com/magefile/mage@v1.15.0
      - run: mage build:dev
      - run: ./bin/grove --version

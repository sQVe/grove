---
phase: 02-output-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
    - cmd/grove/commands/fetch.go
    - cmd/grove/commands/fetch_test.go
autonomous: true

must_haves:
    truths:
        - 'User can run `grove fetch --json` and receive valid JSON output'
        - 'User can run `grove fetch --verbose` and see commit hash details'
        - 'Both flags work correctly when no changes exist'
        - 'JSON contains all change types (new, updated, pruned) with proper field names'
        - 'Verbose shows short hashes (7 chars) for from/to commits'
    artifacts:
        - path: 'cmd/grove/commands/fetch.go'
          provides: 'JSON and verbose output modes'
          contains: 'jsonOutput bool'
        - path: 'cmd/grove/commands/fetch_test.go'
          provides: 'Flag and output tests'
          contains: 'TestFetchCmd.*JSON'
    key_links:
        - from: 'cmd/grove/commands/fetch.go'
          to: 'encoding/json'
          via: 'json.NewEncoder for JSON output'
          pattern: "json\\.NewEncoder"
        - from: 'cmd/grove/commands/fetch.go'
          to: 'internal/formatter'
          via: 'SubItemPrefix for verbose sub-items'
          pattern: "formatter\\.SubItemPrefix"
---

<objective>
Add `--json` and `--verbose` output modes to `grove fetch` command.

Purpose: Enable machine-readable output for scripting and additional commit details for debugging
Output: Working `--json` and `--verbose` flags following established patterns from list.go and status.go
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-output-modes/02-RESEARCH.md
@cmd/grove/commands/fetch.go
@cmd/grove/commands/fetch_test.go
@cmd/grove/commands/list.go (JSON output pattern)
@cmd/grove/commands/status.go (verbose output pattern)
@internal/formatter/formatter.go (SubItemPrefix)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --json flag with JSON output</name>
  <files>cmd/grove/commands/fetch.go, cmd/grove/commands/fetch_test.go</files>
  <action>
Add JSON output mode to fetch command following list.go pattern:

1. Add imports: "encoding/json"

2. Add flag variable and wire to runFetch:
    - var jsonOutput bool
    - cmd.Flags().BoolVar(&jsonOutput, "json", false, "Output as JSON")
    - Pass to runFetch(jsonOutput, verbose) (add verbose param now, implement in Task 2)

3. Define JSON struct types (after remoteResult):

    ```go
    type fetchChangeJSON struct {
        Remote      string `json:"remote"`
        RefName     string `json:"ref"`
        Type        string `json:"type"`
        OldHash     string `json:"old_hash,omitempty"`
        NewHash     string `json:"new_hash,omitempty"`
        CommitCount int    `json:"commit_count,omitempty"`
    }

    type fetchErrorJSON struct {
        Remote  string `json:"remote"`
        Message string `json:"message"`
    }

    type fetchResultJSON struct {
        Changes []fetchChangeJSON `json:"changes"`
        Errors  []fetchErrorJSON  `json:"errors,omitempty"`
    }
    ```

4. Add outputFetchJSON function:
    - Initialize Changes with make([]fetchChangeJSON, 0) (empty array, not null)
    - For each remoteResult: if error, add to Errors; else add changes to Changes
    - For changes: use change.Type.String() for type field, getCommitCount for CommitCount
    - Use json.NewEncoder(os.Stdout) with SetIndent("", " ")

5. Update outputFetchResults signature to accept jsonOutput, verbose bool
    - If jsonOutput, call outputFetchJSON and return early

6. Add tests in fetch_test.go:
    - TestNewFetchCmd_Flags: verify --json flag exists
    - TestFetchChangeJSON: verify JSON struct marshals correctly with omitempty
      </action>
      <verify>

- `make test` passes
- `make lint` passes
  </verify>
  <done>
- --json flag registered on fetch command
- JSON output struct types defined with proper tags
- outputFetchJSON produces valid indented JSON
- Empty results produce {"changes": []} not null
- Tests verify flag registration and JSON marshaling
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add --verbose flag with commit hash details</name>
  <files>cmd/grove/commands/fetch.go, cmd/grove/commands/fetch_test.go</files>
  <action>
Add verbose output mode following status.go pattern:

1. Add imports if not present: "github.com/sqve/grove/internal/config", "github.com/sqve/grove/internal/formatter"

2. Add verbose flag variable:
    - var verbose bool
    - cmd.Flags().BoolVarP(&verbose, "verbose", "v", false, "Show commit hash details")

3. Add printRefChangeVerbose function:
    - Call existing printRefChange first (normal output)
    - Get prefix via formatter.SubItemPrefix()
    - For Updated type with OldHash: print " {prefix} from: {short_hash}" (7 chars)
    - For Updated type with NewHash: print " {prefix} to: {short_hash}" (7 chars)
    - For New type with NewHash: print " {prefix} at: {short_hash}"
    - Use config.IsPlain() for conditional styling (dimmed prefix and hash)

4. Update outputFetchResults:
    - If verbose, call printRefChangeVerbose instead of printRefChange

5. Ensure precedence: JSON > verbose > default (JSON check already first from Task 1)

6. Add tests in fetch_test.go:
    - TestNewFetchCmd_VerboseFlag: verify -v and --verbose flags exist
    - TestPrintRefChangeVerbose: test output includes hash details (capture stdout or test logic)
      </action>
      <verify>

- `make test` passes
- `make lint` passes
  </verify>
  <done>
- --verbose/-v flag registered on fetch command
- Verbose output shows hash sub-items below each change
- Short hashes (7 chars) used for readability
- Plain mode works without ANSI codes
- Tests verify flag registration
  </done>
  </task>

</tasks>

<verification>
After both tasks complete:
1. `make ci` passes (full CI pipeline)
2. Manual verification in grove workspace:
   - `grove fetch --json` outputs valid JSON
   - `grove fetch --verbose` shows hash details
   - `grove fetch --json --verbose` outputs JSON (JSON takes precedence)
   - `grove fetch` (no flags) works as before
</verification>

<success_criteria>

- OUT-02 complete: `grove fetch --json` produces machine-readable JSON
- OUT-03 complete: `grove fetch --verbose` shows commit hash details
- All existing tests pass
- New tests cover flag registration and output behavior
- Follows established patterns from list.go and status.go
  </success_criteria>

<output>
After completion, create `.planning/phases/02-output-modes/02-01-SUMMARY.md`
</output>

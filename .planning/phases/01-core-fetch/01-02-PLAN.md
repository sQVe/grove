---
phase: 01-core-fetch
plan: 02
type: execute
wave: 2
depends_on: ['01-01']
files_modified:
    - cmd/grove/commands/fetch.go
    - cmd/grove/commands/fetch_test.go
    - cmd/grove/commands/root.go
autonomous: true

must_haves:
    truths:
        - 'User can run grove fetch from any directory in workspace'
        - 'Command fetches all configured remotes'
        - 'Output groups changes by remote'
        - 'Remotes with no changes are omitted'
        - 'Progress shows which remote is being fetched'
        - 'All errors collected and reported at end'
    artifacts:
        - path: 'cmd/grove/commands/fetch.go'
          provides: 'Fetch command implementation'
          exports: ['NewFetchCmd']
        - path: 'cmd/grove/commands/fetch_test.go'
          provides: 'Unit tests for fetch command'
          min_lines: 50
    key_links:
        - from: 'cmd/grove/commands/fetch.go'
          to: 'internal/git/fetch.go'
          via: 'import and function calls'
          pattern: "git\\.(FetchRemote|GetRemoteRefs|DetectRefChanges)"
        - from: 'cmd/grove/commands/fetch.go'
          to: 'workspace.FindBareDir'
          via: 'workspace detection'
          pattern: "workspace\\.FindBareDir"
        - from: 'cmd/grove/commands/root.go'
          to: 'cmd/grove/commands/fetch.go'
          via: 'command registration'
          pattern: "rootCmd\\.AddCommand\\(NewFetchCmd"
---

<objective>
Implement the `grove fetch` command with human-readable output.

Purpose: Give users a single command to fetch all remotes and see what changed. Output must be clear, grouped by remote, with progress indication during fetch.

Output: Working `grove fetch` command registered with root, unit tests, proper shell completion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-fetch/01-CONTEXT.md
@.planning/phases/01-core-fetch/01-01-SUMMARY.md
@cmd/grove/commands/list.go
@cmd/grove/commands/root.go
@internal/styles/styles.go
@internal/logger/logger.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fetch command structure</name>
  <files>cmd/grove/commands/fetch.go</files>
  <action>
    Create NewFetchCmd following list.go pattern:
    - Use: "fetch", Short: "Fetch all remotes and show changes"
    - Args: cobra.NoArgs
    - ValidArgsFunction: return nil, cobra.ShellCompDirectiveNoFileComp (no file completions)
    - RunE: call runFetch()

    Implement runFetch():
    1. Get cwd with os.Getwd()
    2. Find bare dir with workspace.FindBareDir(cwd)
    3. List remotes with git.ListRemotes(bareDir)
    4. For each remote:
       - Show progress with logger.StartSpinner("Fetching {remote}...")
       - Capture refs before with git.GetRemoteRefs(bareDir, remote)
       - Execute git.FetchRemote(bareDir, remote)
       - If error, retry once per CONTEXT.md decision
       - Capture refs after with git.GetRemoteRefs
       - Detect changes with git.DetectRefChanges
       - Stop spinner
       - Collect results and errors
    5. Output results (see Task 2)
    6. Report errors at end, return error if any remote failed

    Error handling per CONTEXT.md:
    - Continue fetching other remotes if one fails
    - Retry failed remotes once before giving up
    - Report all failures at end

  </action>
  <verify>File exists and compiles: `go build ./cmd/grove/...`</verify>
  <done>NewFetchCmd function exists, runFetch orchestrates fetch for all remotes with retry logic</done>
</task>

<task type="auto">
  <name>Task 2: Implement output formatting</name>
  <files>cmd/grove/commands/fetch.go</files>
  <action>
    Implement output formatting per CONTEXT.md decisions:

    Group changes by remote:
    ```
    origin:
      + feature/new-branch
      * main (+3 commits)
      - stale-branch (deleted on remote)
    ```

    Symbols and colors (use styles package):
    - New branches: "+" with styles.Success (green)
    - Updated branches: "*" with styles.Warning (yellow), show commit count
    - Pruned refs: "-" with styles.Dimmed, "(deleted on remote)" hint

    Display ref names as short names (strip refs/remotes/{remote}/ prefix)

    Skip remotes with no changes (per CORE-07)

    When no changes on any remote: print "All remotes up to date"

    Commit count for updated branches:
    - Use git rev-list --count OLD..NEW to get count
    - Display as "(+N commits)" or "(-N commits)" if force-pushed back
    - Add helper function getCommitCount(bareDir, oldHash, newHash string) int

    For new branches (optional enhancement):
    - Could show commits ahead of default branch
    - Skip for now (Phase 1 scope), just show as new

  </action>
  <verify>`grove fetch` from test workspace shows formatted output</verify>
  <done>Output shows grouped changes per remote with colors and commit counts</done>
</task>

<task type="auto">
  <name>Task 3: Register command and add unit tests</name>
  <files>cmd/grove/commands/root.go, cmd/grove/commands/fetch_test.go</files>
  <action>
    In root.go: Add `rootCmd.AddCommand(NewFetchCmd())` alongside other commands

    Create fetch_test.go with tests:
    - TestNewFetchCmd: verify command creation, Use, Short, Args, ValidArgsFunction
    - Test that ValidArgsFunction returns ShellCompDirectiveNoFileComp

    Test patterns to follow from list.go tests (if they exist) or doctor_test.go

  </action>
  <verify>`make test` passes, `grove fetch --help` shows command</verify>
  <done>Command registered, unit tests pass, help text visible</done>
</task>

</tasks>

<verification>
```bash
cd /home/sqve/code/personal/grove/main && make test && make build && ./grove fetch --help
```

Manual verification in a test grove workspace:

1. Run `grove fetch` - should show progress and changes
2. Run `grove fetch` again - should show "All remotes up to date"
   </verification>

<success_criteria>

- `make test` passes
- `make build` succeeds
- `grove fetch --help` shows command description
- `grove fetch` from workspace fetches all remotes
- Output groups changes by remote with colors
- Remotes with no changes omitted
- "All remotes up to date" shown when nothing changed
- Errors collected and reported at end
  </success_criteria>

<output>
After completion, create `.planning/phases/01-core-fetch/01-02-SUMMARY.md`
</output>

---
phase: 01-core-fetch
plan: 03
type: execute
wave: 3
depends_on: ['01-02']
files_modified:
    - cmd/grove/testdata/script/fetch_integration.txt
autonomous: true

must_haves:
    truths:
        - 'grove fetch works from any directory in workspace'
        - 'New branches detected and displayed correctly'
        - 'Updated branches detected and displayed correctly'
        - 'Pruned branches detected and displayed correctly'
        - 'No output for remotes with no changes'
    artifacts:
        - path: 'cmd/grove/testdata/script/fetch_integration.txt'
          provides: 'Integration tests for fetch command'
          min_lines: 50
    key_links:
        - from: 'cmd/grove/testdata/script/fetch_integration.txt'
          to: 'grove fetch'
          via: 'testscript exec'
          pattern: 'exec grove fetch'
---

<objective>
Create integration tests for `grove fetch` command using testscript.

Purpose: Verify end-to-end behavior of fetch command with real git repositories. Tests must cover new branches, updated branches, and pruned branches.

Output: `cmd/grove/testdata/script/fetch_integration.txt` with comprehensive integration tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-fetch/01-02-SUMMARY.md
@cmd/grove/testdata/script/add_integration.txt
@cmd/grove/script_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fetch integration test script</name>
  <files>cmd/grove/testdata/script/fetch_integration.txt</files>
  <action>
    Create testscript following pattern from add_integration.txt:

    Setup phase:
    1. Create origin repository with initial commit
    2. Clone into grove workspace using `grove clone`
    3. cd into workspace/main

    Test: Fetch with no changes
    - Run `grove fetch`
    - Verify output contains "All remotes up to date" or similar

    Test: Detect new branch
    - In origin repo, create new branch "feature/new"
    - Run `grove fetch` from workspace
    - Verify output shows new branch with "+"

    Test: Detect updated branch
    - In origin repo, add commit to main
    - Run `grove fetch` from workspace
    - Verify output shows updated branch with "*" and commit count

    Test: Detect pruned branch
    - In origin repo, delete the feature/new branch
    - Run `grove fetch` from workspace
    - Verify output shows pruned ref with "-"

    Test: Works from subdirectory
    - mkdir subdir && cd subdir
    - Run `grove fetch`
    - Should work (workspace detection from any directory)

    Use testscript assertions:
    - `exec grove fetch` for success
    - `stdout 'pattern'` to check output
    - `! stdout 'pattern'` for negative assertion

  </action>
  <verify>`make test-integration` passes</verify>
  <done>Integration tests cover all fetch scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Verify test coverage</name>
  <files>cmd/grove/testdata/script/fetch_integration.txt</files>
  <action>
    Run integration tests and verify all scenarios pass:

    ```bash
    cd /home/sqve/code/personal/grove/main
    go test -v -tags=integration ./cmd/grove/... -run TestScript/fetch
    ```

    If tests fail, debug and fix either:
    - Test expectations (if output format differs)
    - Implementation (if behavior is wrong)

    Ensure tests are not flaky (run multiple times)

  </action>
  <verify>Tests pass consistently on multiple runs</verify>
  <done>All integration tests pass, no flaky tests</done>
</task>

</tasks>

<verification>
```bash
cd /home/sqve/code/personal/grove/main && make test-integration
```

Or run specific test:

```bash
go test -v -tags=integration ./cmd/grove/... -run TestScript/fetch
```

</verification>

<success_criteria>

- `make test-integration` passes
- Test covers: no changes, new branch, updated branch, pruned branch
- Test verifies workspace detection from subdirectory
- Tests are not flaky (pass consistently)
  </success_criteria>

<output>
After completion, create `.planning/phases/01-core-fetch/01-03-SUMMARY.md`
</output>
